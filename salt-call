#!/bin/bash
set -euxo pipefail

repo="$(dirname "$(readlink -f "$0")")"
encrypted=~/.password-store/privat/laptop-pillar-secrets.gpg
tempSecrets=$repo/pillar/secrets.sls

# decrypt pillar data with normal user, save to file as root
( umask 077 && gpg -d $encrypted | sudo tee $tempSecrets > /dev/null )

# run salt
sudo salt-call \
    --local \
    --file-root=$repo/states \
    --pillar-root=$repo/pillar \
    "${@:-state.apply}"

# remove temporary file (only manage secrets in the encrypted file)
sudo rm $tempSecrets

