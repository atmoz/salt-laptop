#!/bin/bash
set -euo pipefail

repo="$(dirname "$(readlink -f "$0")")"
encrypted=~/.password-store/private/laptop-pillar-secrets.gpg
decrypted=$repo/pillar/secrets.sls

# Use encrypted secrets, if available in password-store
if [ -f "$encrypted" ]; then
    # decrypt pillar data with normal user, store file restricted to root only
    ( umask 077 && gpg -qd $encrypted | sudo tee $decrypted > /dev/null )
fi

if [ ! -f "$decrypted" ]; then
    echo "Missing $decrypted. Aborting." >&2; exit 1
fi

sudo /usr/bin/salt-call \
    --local \
    --file-root=$repo/states \
    --pillar-root=$repo/pillar \
    "${@:-state.apply}"
